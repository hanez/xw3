<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>pyxterm.js</title>
    <style>
      html {
        font-family: arial;
      }
    </style>
<link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
<script src="node_modules/xterm/lib/xterm.js"></script>
  </head>
  <body>
    <span style="font-size: small">status:
      <span style="font-size: small" id="status">connecting...</span></span>

    <div id="terminal"></div>
        <script>
      let term = new Terminal({
        cursorBlink: true,
        macOptionIsMeta: true,
        scrollback: true,
      });
      term.attachCustomKeyEventHandler(customKeyEventHandler);

      term.open(document.getElementById("terminal"));
      term.resize(15, 50);
      console.log(`size: ${term.cols} columns, ${term.rows} rows`);
      term.writeln("Welcome to pyxterm.js!");
      term.writeln("https://github.com/cs01/pyxterm.js");
      term.writeln('')
      term.writeln("You can copy with ctrl+shift+x");
      term.writeln("You can paste with ctrl+shift+v");
      term.writeln('')

      const ws = new WebSocket("ws://localhost:8081/");
      const status = document.getElementById("status");

      term.onData((data) => {
        console.log("browser terminal received new data:", data);
        sendMessage(data);
      });

      term.onKey(e => {
    console.log(e.key);
    term.write(e.key);
    if (e.key == '\r')
        term.write('\n');
})

      ws.onmessage(function (event) {
        console.log("new output received from server:", event.data);
        term.write(event.data);
      });

      function sendMessage(data) {
          ws.send(data);
      }

      function customKeyEventHandler(e) {
        if (e.type !== "keydown") {
          return true;
        }
        if (e.ctrlKey && e.shiftKey) {
          const key = e.key.toLowerCase();
          if (key === "v") {
            // ctrl+shift+v: paste whatever is in the clipboard
            navigator.clipboard.readText().then((toPaste) => {
              term.writeText(toPaste);
            });
            return false;
          } else if (key === "c" || key === "x") {
            // ctrl+shift+x: copy whatever is highlighted to clipboard

            // 'x' is used as an alternate to 'c' because ctrl+c is taken
            // by the terminal (SIGINT) and ctrl+shift+c is taken by the browser
            // (open devtools).
            // I'm not aware of ctrl+shift+x being used by anything in the terminal
            // or browser
            const toCopy = term.getSelection();
            navigator.clipboard.writeText(toCopy);
            term.focus();
            return false;
          }
        }
        return true;
      }
    </script>
  </body>
</html>
